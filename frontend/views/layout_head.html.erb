<%= stylesheet_link_tag "#{AppConfig[:frontend_prefix]}assets/history.css" %>

<% if controller.controller_name == 'history' %>
  <%= javascript_include_tag 'history' %>
  <script>

    $(function() {
      var as_history = new ASHistory();
      window.as_history = as_history;
    });

  </script>
<% end %>


<%
  history_uri = false
  unless action_name == 'new'
    [
     @repository,
     @archival_object,
     @resource,
     @digital_object_component,
     @digital_object,
     @accession,
     @agent
    ].each do |obj|
      if obj
        if obj.respond_to?(:history)
          history_uri = obj.history['ref']
          break
        elsif obj.respond_to?(:repository) && obj.repository.has_key?('history')
          history_uri = obj.repository['history']['ref']
          break
        end
      end
    end
  end
%>

<% if controller.action_name == 'show' && history_uri %>
  <meta name="history_uri" content="<%= history_uri %>">
  <script>

  $(function() {

    var as_history = new ASHistory();
    window.as_history = as_history;

  });

    // for resources - sigh
    $(window).on("loadedrecordform.aspace", function() {
      $('#archivesSpaceSidebar').append('<%=j render partial: 'history/button', :locals => {:uri => history_uri} %>');
    });
    // for the other record types - sigh
    $(function() {
      if (!$('#as-history-button').length) {
        $('#archivesSpaceSidebar').append('<%=j render partial: 'history/button', :locals => {:uri => history_uri} %>');
      }

      <% if history_uri.start_with?('/history/resource/') %>
        monitorTreeChanges();
      <% end %>



    });

    // HELPME: there must be a better way!
    function monitorTreeChanges() {
      var id = $('.largetree-node.current').attr('id');
      if (typeof id !== 'undefined') {
        var uri = '/history/' + id.replace(/_(\d+)$/, '/$1');
        var but = $('#as-history-button');
        if (but.attr('href') !== uri) {
          but.attr('href', uri);
        }
      }
      setTimeout(function() { monitorTreeChanges() }, 1000);
    }

  </script>
<% end %>
